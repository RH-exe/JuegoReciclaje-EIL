<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Selección de Área</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden; /* fuerza que nunca aparezca scroll */
  }
</style>
</head>
<body class="bg-gray-100">

  <!-- HEADER -->
  <header class="bg-white border-b-8 border-lime-500 flex items-center justify-between">
      <img src="../sources/imagess/logo-eil.png" alt="EIL" class="h-20 w-auto px-10 py-2 my-2 ">
      <button id="jugar" class="rounded-xl bg-blue-800 h-12 w-36 text-white mr-12"> Jugar</button>
  </header>
<main class="w-full bg-[url('../sources/imagess/fondo.jpg')] bg-center bg-cover flex items-center justify-center overflow-hidden" style="height: calc(100vh - 96px); ">
  <!-- Caja de contenido -->
  <div class="bg-white/60 rounded-2xl shadow-lg p-8 w-[60%] max-w-6xl">

    <!-- GRID DE BOTONES -->
    <div id="contenedor" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 text-center">
    </div>
  </div>
</main>
  <!-- SCRIPT -->
  <script>
    const  params = new URLSearchParams(window.location.search);
    const usuario_DNI = params.get("dni");
    console.log(usuario_DNI);
    const areas = [
      {nombre : "Desorción", nombreArea: "DESORCION", puntaje : 0},
      {nombre : "T.I", nombreArea: "TI",  puntaje : 0},
      {nombre : "Fundición y refinación", nombreArea: "FUNDICION Y REFINACION", puntaje : 0},
      {nombre : "Administración", nombreArea: "ADMINISTRACION", puntaje : 0},
      {nombre : "Laboratorio quimico", nombreArea: "LABORATORIO QUIMICO", puntaje : 0},
      {nombre : "Laboratorio metalurgico", nombreArea: "LABORATORIO METALURGICO", puntaje : 0},
      {nombre : "Mantenimiento", nombreArea: "MANTENIMIENTO", puntaje : 0},
      {nombre : "Ssoma", nombreArea: "SSOMA", puntaje : 0},
      {nombre : "Contabilidad", nombreArea: "CONTABILIDAD",  puntaje : 0},
      {nombre : "Cumplimiento", nombreArea: "CUMPLIMIENTO", puntaje : 0},
      {nombre : "Gestion Humana", nombreArea: "GESTION HUMANA", puntaje : 0},
      {nombre : "Tesoreria", nombreArea: "TESORERIA", puntaje : 0},
      {nombre : "Gerencia General", nombreArea: "GERENCIA GENERAL", puntaje : 0},
      {nombre : "Comercial", nombreArea: "COMERCIAL", puntaje : 0},
      {nombre : "Logistica", nombreArea: "LOGISTICA", puntaje : 0},
      {nombre : "Planta", nombreArea: "PLANTA", puntaje : 0},
      {nombre : "Servicios Generales", nombreArea: "SERVICIOS GENERALES", puntaje : 0},
      {nombre : "Almacen", nombreArea: "ALMACEN", puntaje : 0} 
    ];
    const contenedor = document.getElementById("contenedor");

    function blockArea (){
      contenedor.innerHTML = "";
      areas.forEach(area =>{          
        //BG BUTTON: bg-blue-900 text-white
        const button = document.createElement("button");
        button.className = `w-full h-16 cursor-pointer rounded-xl font-semibold text-xl shadow-md hover:scale-105 transition-transform flex flex-col justify-center bg-lime-500 text-black`;

        const nombre = document.createElement("span");
        nombre.textContent = area.nombre;

        const puntaje = document.createElement("span");
        puntaje.textContent = `Puntaje: ${area.puntaje ?? 0}`;
        puntaje.className= 'text-red-600  text-xs'

        button.appendChild(nombre);
        button.appendChild(puntaje);
        contenedor.appendChild(button);

        button.addEventListener('click', async ()=>{
          const nombreArea = area.nombreArea;
          const dni = usuario_DNI;
          try{
            const response = await fetch("../sources/php/buscar_DNI.php",{
              method : "POST",
              headers : {"Content-Type" : "application/json"},
              body: JSON.stringify({DNI: dni})
            })

            if(!response) throw new Error ("Error con la conexion con el servisor");
            const data = await response.json();
            const usuario = data[0];

            if(nombreArea){
              window.location.href = `puntajeArea.html?dni=${encodeURIComponent(dni)}&area=${encodeURIComponent(nombreArea)}` ;
            }
          }catch(err){
            console.log("error al encontrar el area", err)
          }
        })
      })
    };

    async function cargarPuntaje() {
      try{
        const res = await fetch("../sources/php/puntajeArea.php");
        if (!res.ok) throw new Error(`Error HTTP: ${res.status}`);
        const data = await res.json();

        console.log("Datos recibidos:", data);

        areas.forEach(area =>{
          const areaPuntaje = data[area.nombreArea];
          if(areaPuntaje) {
            area.puntaje = areaPuntaje;
          }
        });

        blockArea();
      }catch(err){
        console.error("error al cargar el puntaje", err);
        blockArea();
      }
    }

    const boton = document.getElementById("jugar");

    boton.addEventListener('click',async ()=>{
        const {value:login} = await swal.fire({
            title: "ingresar  su DNI",
            input: "text",
            allowOutsideClick: false,
            inputAttribures: {autocapitalize : "off"},
            showCancelButton: true,
            confirmButtonText: "Ingresar",
            showLoaderOnConfirm: false,
            preConfirm: async (dniIngresado)=>{
                if(!dniIngresado){
                    Swal.showValidationMessage("Por faovr Ingrese su DNI");
                    return false;
                }
                try{
                    const response = await fetch("../sources/php/buscar_DNI.php",{
                        method :"POST",
                        headers : {"Content-Type": "application/json"},
                        body: JSON.stringify({DNI:dniIngresado})
                    })

                    if(!response.ok){
                        throw new Error ("Error con la conexion con el servidor");
                    }

                    const data = await response.json();
                    console.log("respuesta del servidor", data);

                    if(!data || data.length ===0){
                        Swal.showValidationMessage("DNI no encontrado");
                        return false;
                    }
                    const puntaje = parseFloat(data[0].puntaje || 0);
                    const nuevaArea = data[0].u_Area;
                    const nuevoDni = data[0].u_DNI;

                    if(puntaje>0){
                        await Swal.fire({
                        icon : "warning",
                        text: `DNI registrado ya jugo, su puntaje es ${puntaje}`,
                        confirmButtonText : "Ingrese un otro DNI"
                        });
                        ingresaDNI();
                        return false;
                    }else{
                        Swal.fire({
                            icon: "warning",
                            title: `Redirigiendo.. `,
                            timer: 2500,
                            showConfirmButton: false
                        }).then(() =>{
                            window.location.href= "inicio.html?area=" + encodeURIComponent(nuevaArea)+"&dni="+encodeURIComponent(nuevoDni);
                        })
                    }         

                    return data;
                }catch(error){
                    Swal.showValidationMessage(`Error, ${error.message}`);
                }
            }
        })
    })

    cargarPuntaje();

  </script>
</body>
</html>

